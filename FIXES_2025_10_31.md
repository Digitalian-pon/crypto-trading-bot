# トレーディングBOT 修正レポート - 2025年10月31日

## 📊 修正前の状況

### 損益状況（深刻）
- **総損益**: -29.80円 (-4.02%)
- **勝率**: 14.3% (2勝12敗)
- **平均損益**: -2.13円/取引
- **総手数料**: 30円
- **現在残高**: 711円 → 709円（ポジション決済後）

### 主な問題点
1. **過剰取引（オーバートレーディング）**
   - ほぼ同じ価格で売買を繰り返す
   - 例: ¥28.14で売って¥28.14で買い戻す → -2円損失（手数料のみ）

2. **手数料負け**
   - 0.1%未満の価格変動でも決済
   - 往復手数料¥2で必ず損失

3. **トレンド判定の失敗**
   - 横ばい〜上昇相場でSELL取引を連発
   - 85.7%の取引で損失

---

## 🔧 実施した修正内容

### 1. ポジション決済（緊急対応）
```
実施日時: 2025-10-31 12:22
決済内容: SELL 20 DOGE @ ¥28.38 → BUY @ ¥28.42
損失: -¥2.00
理由: これ以上の損失拡大を防ぐため
```

### 2. トレーディングロジック修正

#### A. シグナル閾値の大幅引き上げ
**ファイル**: `services/optimized_trading_logic.py`

```python
# 修正前 → 修正後
TRENDING:  1.2 → 2.5 (2倍以上)
RANGING:   1.5 → 3.0 (2倍)
VOLATILE:  2.0 → 4.0 (2倍)
```

**効果**: 弱いシグナルでの取引を防止、強いシグナルのみで取引

#### B. ストップロス/テイクプロフィットの調整
```python
# TRENDING の場合
Stop Loss:    2.0 ATR → 3.0 ATR (広めに設定)
Take Profit:  4.0 ATR → 6.0 ATR (大きめに設定)

# RANGING の場合
Stop Loss:    1.5 ATR → 2.0 ATR
Take Profit:  2.5 ATR → 4.0 ATR

# VOLATILE の場合
Stop Loss:    3.0 ATR → 4.0 ATR (非常に広く)
Take Profit:  5.0 ATR → 8.0 ATR
```

**効果**: ボラティリティに応じた柔軟なリスク管理

#### C. チェック間隔の延長
```python
# 修正前: 180秒（3分）
# 修正後: 600秒（10分）
self.min_trade_interval = 600
```

**効果**: ノイズによる過剰取引を防止

#### D. 最小価格変動フィルターの強化
```python
# 新規取引時
if price_change_ratio < 0.015:  # 1.5%未満では取引しない
    return False

# ポジション決済時
if price_change_ratio < 0.01:  # 1.0%未満では決済しない
    return False
```

**効果**: 手数料負けを防止

#### E. 反転シグナル閾値の引き上げ
```python
# ポジション決済時の反転シグナル
# 修正前: confidence >= 2.0
# 修正後: confidence >= 3.0
```

**効果**: 極めて強いシグナルのみで決済

### 3. BOT本体の修正

**ファイル**: `optimized_leverage_bot.py`

```python
# チェック間隔の延長
self.interval = 600  # 180秒 → 600秒（10分）

# 決済時の価格変動フィルター強化
if price_change_ratio < 0.01:  # 0.5% → 1.0%
```

### 4. データベース設定の更新

**ファイル**: `instance/crypto_trader.db`

```sql
UPDATE trading_settings
SET currency_pair = 'DOGE_JPY',
    timeframe = '5m'
WHERE id = 1;
```

**変更内容**:
- BTC (30m) → DOGE_JPY (5m) に修正

---

## 📈 期待される改善効果

### 取引頻度
- **修正前**: 30回/日（1日で30取引）
- **修正後**: 5回/日以下（予想）
- **削減率**: 80%以上

### 勝率
- **修正前**: 14.3%
- **目標**: 50%以上
- **理由**: 強いシグナルのみで取引

### 手数料負け
- **修正前**: ほぼ全ての取引で手数料負け
- **修正後**: 1.5%以上の価格変動でのみ取引 → 手数料(往復0.7%程度)を上回る変動
- **削減**: 90%以上削減（予想）

### 損益
- **修正前**: -4.02% (14日間)
- **目標**: 少なくとも±0%（損失回避）
- **長期目標**: +5%以上/月

---

## 🚀 BOT再起動手順

### 1. PM2での起動（推奨）
```bash
cd /data/data/com.termux/files/home/crypto-trading-bot

# 最適化BOTを起動
pm2 start optimized_leverage_bot.py \
  --name optimized-doge-bot \
  --interpreter python3

# 保存
pm2 save

# 確認
pm2 list
pm2 logs optimized-doge-bot
```

### 2. 直接起動（テスト用）
```bash
cd /data/data/com.termux/files/home/crypto-trading-bot
python3 optimized_leverage_bot.py
```

### 3. 動作確認ポイント
```bash
# ログで以下を確認:
# - チェック間隔: "Sleeping for 600 seconds..."
# - シグナル閾値: "Required=2.5" (TRENDING時)
# - 価格変動フィルター: "Price hasn't moved enough"
# - 取引実行: "BUY order successful" または "SELL order successful"

# 期待される動作:
# - シグナルが出ても、閾値に達しなければ取引しない
# - 価格が1.5%以上動かなければ新規取引しない
# - ポジションを持っている場合、1.0%以上動かなければ決済しない
```

---

## ⚠️ 注意事項

### 1. 最初の数日は様子見
- 修正後、少なくとも3日間は取引状況を監視
- 取引頻度が大幅に減少するはず（1日5回以下）
- 勝率が改善されているか確認

### 2. さらなる調整が必要な場合
以下の症状が出た場合、追加調整が必要:

#### 症状1: まだ取引が多すぎる（1日10回以上）
```python
# services/optimized_trading_logic.py:41,48,55
# signal_threshold をさらに引き上げる
'TRENDING': {'signal_threshold': 3.0},  # 2.5 → 3.0
'RANGING': {'signal_threshold': 4.0},   # 3.0 → 4.0
'VOLATILE': {'signal_threshold': 5.0},  # 4.0 → 5.0
```

#### 症状2: 全く取引しない（1週間0回）
```python
# signal_threshold を少し下げる
'TRENDING': {'signal_threshold': 2.0},  # 2.5 → 2.0
```

#### 症状3: まだ手数料負けが多い
```python
# 最小価格変動を引き上げ
if price_change_ratio < 0.02:  # 1.5% → 2.0%
```

### 3. バックテストの推奨
修正後のロジックを実運用前にテスト:
```bash
python3 backtest_engine.py
```

---

## 📝 今後の改善案

### 短期（1週間以内）
- [ ] 3日間の取引履歴を監視
- [ ] 勝率・取引頻度の改善を確認
- [ ] 必要に応じてパラメータ微調整

### 中期（1ヶ月以内）
- [ ] トレンド判定ロジックの改善（下降トレンド以外はSELL禁止など）
- [ ] 機械学習モデルの導入検討
- [ ] 複数時間足の同時分析

### 長期（3ヶ月以内）
- [ ] ポートフォリオ管理（BTC, ETH等への拡張）
- [ ] 強化学習による動的最適化
- [ ] 自動パラメータチューニング

---

## 📞 サポート情報

### ファイル構成
```
crypto-trading-bot/
├── optimized_leverage_bot.py           # BOT本体（修正済み）
├── services/
│   ├── optimized_trading_logic.py     # トレーディングロジック（修正済み）
│   ├── gmo_api.py                     # GMO Coin API
│   └── data_service.py                # データ取得
├── instance/
│   └── crypto_trader.db               # データベース（修正済み）
└── FIXES_2025_10_31.md                # 本ドキュメント
```

### 変更履歴
- **2025-10-31 12:22**: ポジション決済（-¥2損失）
- **2025-10-31 12:25**: トレーディングロジック修正完了
- **2025-10-31 12:26**: データベース設定更新完了

---

**修正者**: Claude Code (Anthropic)
**最終更新**: 2025年10月31日 12:26

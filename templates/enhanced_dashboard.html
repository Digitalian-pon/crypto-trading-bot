<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced AI Trading Dashboard - 統合AIトレーディングダッシュボード</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-active { border-left-color: #28a745; }
        .status-inactive { border-left-color: #dc3545; }
        .status-warning { border-left-color: #ffc107; }
        
        .signal-indicator {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .signal-buy { background-color: #d4edda; color: #155724; }
        .signal-sell { background-color: #f8d7da; color: #721c24; }
        .signal-hold { background-color: #fff3cd; color: #856404; }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .indicator-value {
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .auto-refresh {
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .price-change-positive { color: #28a745; }
        .price-change-negative { color: #dc3545; }
        
        .loading {
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-robot me-2"></i>Enhanced AI Trading Dashboard
            </span>
            <div class="navbar-text">
                <span id="current-time"></span>
                <span class="badge bg-info ms-2" id="refresh-indicator">
                    <i class="fas fa-sync-alt" id="refresh-icon"></i> Auto-refresh: 30s
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-3">
        <!-- Status Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card {{ 'status-active' if trading_status.ai_active else 'status-inactive' }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">AI Controller</h6>
                                <span class="badge {{ 'bg-success' if trading_status.ai_active else 'bg-danger' }}">
                                    {{ 'ACTIVE' if trading_status.ai_active else 'INACTIVE' }}
                                </span>
                            </div>
                            <div class="text-primary">
                                <i class="fas fa-robot fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card {{ 'status-active' if trading_status.trading_enabled else 'status-inactive' }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Trading Status</h6>
                                <span class="badge {{ 'bg-success' if trading_status.trading_enabled else 'bg-danger' }}">
                                    {{ 'ENABLED' if trading_status.trading_enabled else 'DISABLED' }}
                                </span>
                            </div>
                            <div class="text-success">
                                <i class="fas fa-chart-line fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card status-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Open Positions</h6>
                                <span class="metric-value">{{ trading_status.open_positions }}</span>
                            </div>
                            <div class="text-warning">
                                <i class="fas fa-chart-pie fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card status-active">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Trades</h6>
                                <span class="metric-value">{{ performance.get('trade_count', 0) }}</span>
                            </div>
                            <div class="text-info">
                                <i class="fas fa-exchange-alt fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Data & Controls -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-candlestick me-2"></i>Market Data
                        </h5>
                        <div>
                            <span class="badge bg-primary">{{ market_data.get('symbol', 'N/A') }}</span>
                            <span id="signal-badge" class="signal-indicator signal-hold ms-2">LOADING...</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h3 class="text-primary mb-1">
                                    ¥<span id="current-price">{{ "%.3f"|format(market_data.get('current_price', 0)) }}</span>
                                </h3>
                                <small class="text-muted">Current Price</small>
                                
                                <div class="mt-3">
                                    <div class="row">
                                        <div class="col-6">
                                            <strong>Volume (24h)</strong><br>
                                            <span class="indicator-value">{{ "{:,.0f}"|format(market_data.get('volume_24h', 0)) }}</span>
                                        </div>
                                        <div class="col-6">
                                            <strong>Change (24h)</strong><br>
                                            <span class="indicator-value">{{ "%.2f"|format(market_data.get('change_24h', 0)) }}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Account Balance</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <strong>JPY</strong><br>
                                        <span class="indicator-value">¥{{ "{:,.0f}"|format(market_data.get('balance_jpy', 0)) }}</span>
                                    </div>
                                    <div class="col-6">
                                        <strong>{{ market_data.get('symbol', 'CRYPTO').split('_')[0] }}</strong><br>
                                        <span class="indicator-value">{{ "%.4f"|format(market_data.get('balance_crypto', 0)) }}</span>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Technical Indicators</h6>
                                    <div id="indicators-display">
                                        <small class="text-muted">Loading indicators...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>AI Controls
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button id="start-ai-btn" class="btn btn-success" {{ 'disabled' if trading_status.trading_enabled else '' }}>
                                <i class="fas fa-play me-2"></i>Start AI Trading
                            </button>
                            <button id="stop-ai-btn" class="btn btn-danger" {{ 'disabled' if not trading_status.trading_enabled else '' }}>
                                <i class="fas fa-stop me-2"></i>Stop AI Trading
                            </button>
                            <hr>
                            <button id="manual-buy-btn" class="btn btn-outline-success">
                                <i class="fas fa-arrow-up me-2"></i>Manual Buy
                            </button>
                            <button id="manual-sell-btn" class="btn btn-outline-danger">
                                <i class="fas fa-arrow-down me-2"></i>Manual Sell
                            </button>
                            <hr>
                            <a href="{{ url_for('enhanced_dashboard.settings') }}" class="btn btn-outline-primary">
                                <i class="fas fa-sliders-h me-2"></i>Settings
                            </a>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Performance Metrics</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td>Win Rate</td>
                                    <td class="text-end">{{ "%.1f"|format(performance.get('win_rate', 0)) }}%</td>
                                </tr>
                                <tr>
                                    <td>Total Profit</td>
                                    <td class="text-end {{ 'text-success' if performance.get('total_profit', 0) > 0 else 'text-danger' }}">
                                        ¥{{ "%.2f"|format(performance.get('total_profit', 0)) }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Daily Profit</td>
                                    <td class="text-end {{ 'text-success' if performance.get('daily_profit', 0) > 0 else 'text-danger' }}">
                                        ¥{{ "%.2f"|format(performance.get('daily_profit', 0)) }}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Recent Trades
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Time</th>
                                        <th>Pair</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>P&L</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for trade in recent_trades %}
                                    <tr>
                                        <td>{{ trade.timestamp[:19].replace('T', ' ') }}</td>
                                        <td>{{ trade.currency_pair }}</td>
                                        <td>
                                            <span class="badge {{ 'bg-success' if trade.trade_type.upper() == 'BUY' else 'bg-danger' }}">
                                                {{ trade.trade_type.upper() }}
                                            </span>
                                        </td>
                                        <td>{{ "%.4f"|format(trade.amount) }}</td>
                                        <td>¥{{ "%.3f"|format(trade.price) }}</td>
                                        <td>
                                            <span class="badge {{ 'bg-warning' if trade.status == 'open' else 'bg-secondary' }}">
                                                {{ trade.status.upper() }}
                                            </span>
                                        </td>
                                        <td class="{{ 'text-success' if trade.profit_loss > 0 else 'text-danger' if trade.profit_loss < 0 else '' }}">
                                            {{ "¥%.2f"|format(trade.profit_loss) if trade.profit_loss else '-' }}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">No trades yet</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let refreshInterval;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            startAutoRefresh();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });
        
        // Auto-refresh functionality
        function startAutoRefresh() {
            refreshData();
            refreshInterval = setInterval(refreshData, 30000); // 30 seconds
        }
        
        function refreshData() {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('auto-refresh');
            
            // Update market data
            fetch('/enhanced/api/market-data')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateMarketData(data.data);
                    }
                })
                .catch(error => console.error('Market data error:', error));
            
            // Update trading signal
            fetch('/enhanced/api/trading-signal')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateTradingSignal(data);
                    }
                })
                .catch(error => console.error('Trading signal error:', error))
                .finally(() => {
                    refreshIcon.classList.remove('auto-refresh');
                });
        }
        
        function updateMarketData(data) {
            document.getElementById('current-price').textContent = data.current_price.toFixed(3);
            // Update other market data fields as needed
        }
        
        function updateTradingSignal(data) {
            const signalBadge = document.getElementById('signal-badge');
            const signal = data.signal;
            
            // Remove all signal classes
            signalBadge.classList.remove('signal-buy', 'signal-sell', 'signal-hold');
            
            // Add appropriate class and update text
            if (signal === 'BUY') {
                signalBadge.classList.add('signal-buy');
                signalBadge.textContent = 'BUY SIGNAL';
            } else if (signal === 'SELL') {
                signalBadge.classList.add('signal-sell');
                signalBadge.textContent = 'SELL SIGNAL';
            } else {
                signalBadge.classList.add('signal-hold');
                signalBadge.textContent = 'HOLD';
            }
            
            // Update indicators
            if (data.indicators) {
                const indicatorsDiv = document.getElementById('indicators-display');
                indicatorsDiv.innerHTML = `
                    <div class="row small">
                        <div class="col-6">RSI: <span class="indicator-value">${data.indicators.rsi}</span></div>
                        <div class="col-6">MACD: <span class="indicator-value">${data.indicators.macd.toFixed(6)}</span></div>
                        <div class="col-6">EMA12: <span class="indicator-value">${data.indicators.ema_12.toFixed(2)}</span></div>
                        <div class="col-6">EMA26: <span class="indicator-value">${data.indicators.ema_26.toFixed(2)}</span></div>
                    </div>
                `;
            }
        }
        
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('ja-JP');
        }
        
        // AI control buttons
        document.getElementById('start-ai-btn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting...';
            
            fetch('/enhanced/api/start-ai')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('AI trading started successfully');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error starting AI: ' + error);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-play me-2"></i>Start AI Trading';
                });
        });
        
        document.getElementById('stop-ai-btn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Stopping...';
            
            fetch('/enhanced/api/stop-ai')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('AI trading stopped successfully');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error stopping AI: ' + error);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-stop me-2"></i>Stop AI Trading';
                });
        });
        
        // Manual trade buttons
        document.getElementById('manual-buy-btn').addEventListener('click', function() {
            executeManualTrade('BUY', this);
        });
        
        document.getElementById('manual-sell-btn').addEventListener('click', function() {
            executeManualTrade('SELL', this);
        });
        
        function executeManualTrade(signal, button) {
            if (!confirm(`Are you sure you want to execute a ${signal} trade?`)) return;
            
            button.disabled = true;
            const originalText = button.innerHTML;
            button.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Executing...`;
            
            fetch('/enhanced/api/execute-trade', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ signal: signal })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${signal} trade executed successfully at ¥${data.price.toFixed(3)}`);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error executing trade: ' + error);
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = originalText;
                });
        }
    </script>
</body>
</html>
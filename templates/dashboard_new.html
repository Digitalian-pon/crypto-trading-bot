{% extends "layout.html" %}

{% block title %}ダッシュボード - GMO コイン取引ボット{% endblock %}

{% block head_content %}
<style>
    body {
        background-color: #121212;
        color: #e0e0e0;
    }
    
    .card {
        background-color: #1e1e1e;
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }
    
    .card-header {
        background-color: #2d2d2d;
        border-bottom: none;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        font-weight: 600;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin-bottom: 20px;
    }
    
    .indicator-container {
        height: 200px;
        position: relative;
    }
    
    .stats-card {
        text-align: center;
        padding: 15px;
        border-radius: 10px;
        height: 100%;
    }
    
    .stats-card .icon {
        font-size: 2rem;
        margin-bottom: 10px;
        color: #3a80ff;
    }
    
    .stats-card .stats-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stats-card .stats-label {
        color: #a0a0a0;
        font-size: 0.9rem;
    }
    
    .btn-primary {
        background-color: #3a80ff;
        border-color: #3a80ff;
    }
    
    .btn-primary:hover {
        background-color: #2970ff;
        border-color: #2970ff;
    }
    
    .btn-success {
        background-color: #2ecc71;
        border-color: #2ecc71;
    }
    
    .btn-success:hover {
        background-color: #27ae60;
        border-color: #27ae60;
    }
    
    .btn-danger {
        background-color: #e74c3c;
        border-color: #e74c3c;
    }
    
    .btn-danger:hover {
        background-color: #c0392b;
        border-color: #c0392b;
    }
    
    .btn-outline-primary {
        color: #3a80ff;
        border-color: #3a80ff;
    }
    
    .btn-outline-primary:hover, .btn-outline-primary.active {
        background-color: #3a80ff;
        border-color: #3a80ff;
        color: white;
    }
    
    .interval-btn, .indicator-btn {
        border-radius: 20px;
        padding: 0.25rem 0.75rem;
        font-size: 0.85rem;
    }
    
    .badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: 500;
    }
    
    .table {
        color: #e0e0e0;
    }
    
    .table thead th {
        border-bottom: 2px solid #2d2d2d;
        background-color: #252525;
        color: #a0a0a0;
    }
    
    .table-hover tbody tr:hover {
        background-color: #252525;
    }
    
    .modal-content {
        background-color: #1e1e1e;
        color: #e0e0e0;
    }
    
    .modal-header {
        border-bottom: 1px solid #2d2d2d;
    }
    
    .modal-footer {
        border-top: 1px solid #2d2d2d;
    }
    
    #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }
    
    .toast {
        background-color: #1e1e1e;
        color: #e0e0e0;
    }
    
    .text-success {
        color: #2ecc71 !important;
    }
    
    .text-danger {
        color: #e74c3c !important;
    }
    
    .form-control, .form-select {
        background-color: #252525;
        border: 1px solid #333;
        color: #e0e0e0;
    }
    
    .form-control:focus, .form-select:focus {
        background-color: #2a2a2a;
        border-color: #3a80ff;
        box-shadow: 0 0 0 0.25rem rgba(58, 128, 255, 0.25);
        color: #e0e0e0;
    }
    
    .form-label {
        color: #a0a0a0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- ヘッダー -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="mb-0"><i class="fas fa-chart-line text-primary me-2"></i> 取引ダッシュボード</h1>
            <p class="text-muted">仮想通貨の自動取引と市場分析</p>
        </div>
        <div class="col-md-4 text-end">
            {% if settings and settings.trading_enabled %}
            <form action="{{ url_for('dashboard.stop_bot') }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-danger btn-lg">
                    <i class="fas fa-stop-circle me-2"></i> 自動取引を停止
                </button>
            </form>
            {% else %}
            <form action="{{ url_for('dashboard.start_bot') }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-play-circle me-2"></i> 自動取引を開始
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- 統計カード -->
    <div class="row mb-4">
        <!-- 統計エラーメッセージ -->
        <div class="col-12 mb-3">
            <div class="alert alert-danger d-none" id="stats-error-message" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span>取引統計の取得に失敗しました。</span>
            </div>
        </div>
        
        <!-- 現在価格 -->
        <div class="col-md-3 mb-4">
            <div class="card stats-card">
                <div class="icon">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="stats-value" id="ticker-price">
                    {% if ticker_info %}
                    {{ ticker_info[0]['last'] }}¥
                    {% else %}
                    ---
                    {% endif %}
                </div>
                <div class="stats-label" id="ticker-currency-label">{{ (settings.currency_pair if settings else 'DOGE_JPY').replace('_', '/') }} 現在価格</div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted" id="ticker-bid">買値: {{ ticker_info[0]['bid'] if ticker_info else '---' }}¥</small>
                    <small class="text-muted" id="ticker-ask">売値: {{ ticker_info[0]['ask'] if ticker_info else '---' }}¥</small>
                </div>
            </div>
        </div>
        
        <!-- アクティブ取引 -->
        <div class="col-md-3 mb-4">
            <div class="card stats-card">
                <div class="icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="stats-value" id="active-trades-count">0</div>
                <div class="stats-label">アクティブな取引</div>
                <div class="mt-2" id="active-pl">
                    <span class="badge bg-secondary">0.00¥</span>
                </div>
            </div>
        </div>
        
        <!-- 損益 -->
        <div class="col-md-3 mb-4">
            <div class="card stats-card">
                <div class="icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="stats-value" id="realized-pl">
                    0.00¥
                </div>
                <div class="stats-label">総合損益</div>
                <div class="mt-2 d-flex justify-content-center">
                    <span class="badge bg-primary me-2" id="win-rate">0%</span>
                    <span class="badge bg-info" id="open-trades-count">0取引中</span>
                </div>
            </div>
        </div>
        
        <!-- 取引状態 -->
        <div class="col-md-3 mb-4">
            <div class="card stats-card">
                <div class="icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="stats-value">
                    {% if settings and settings.trading_enabled %}
                    <i class="fas fa-check-circle text-success"></i>
                    {% else %}
                    <i class="fas fa-times-circle text-danger"></i>
                    {% endif %}
                </div>
                <div class="stats-label">
                    {% if settings and settings.trading_enabled %}
                    自動取引稼働中
                    {% else %}
                    自動取引停止中
                    {% endif %}
                </div>
                <div class="mt-2">
                    <span class="badge bg-secondary">{{ (settings.currency_pair if settings else 'XRP_JPY').replace('_', '/') }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- チャート部分 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h5 class="mb-0 me-3"><i class="fas fa-chart-line me-2"></i> 価格チャート</h5>
                        <span id="current-interval-label" class="badge bg-info">5分足</span>
                        <span id="current-symbol-label" class="badge bg-secondary ms-2">{{ (settings.currency_pair if settings else 'DOGE_JPY').replace('_', '/') }}</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <select class="form-select me-3" id="chart-symbol-select" style="width: auto;">
                            <option value="BTC_JPY" {% if settings and settings.currency_pair == 'BTC_JPY' %}selected{% endif %}>BTC/JPY</option>
                            <option value="ETH_JPY" {% if settings and settings.currency_pair == 'ETH_JPY' %}selected{% endif %}>ETH/JPY</option>
                            <option value="LTC_JPY" {% if settings and settings.currency_pair == 'LTC_JPY' %}selected{% endif %}>LTC/JPY</option>
                            <option value="XRP_JPY" {% if settings and settings.currency_pair == 'XRP_JPY' %}selected{% endif %}>XRP/JPY</option>
                            <option value="DOGE_JPY" {% if settings and settings.currency_pair == 'DOGE_JPY' %}selected{% endif %}>DOGE/JPY</option>
                        </select>
                        <button type="button" class="btn btn-success btn-sm me-3" id="refresh-chart-btn">
                            <i class="fas fa-sync-alt me-1"></i> チャート更新
                        </button>
                        <button type="button" class="btn btn-info btn-sm me-3" id="force-refresh-btn">
                            <i class="fas fa-download me-1"></i> 新データ取得
                        </button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary interval-btn active" data-interval="5min">5分</button>
                            <button type="button" class="btn btn-sm btn-outline-primary interval-btn" data-interval="15min">15分</button>
                            <button type="button" class="btn btn-sm btn-outline-primary interval-btn" data-interval="30min">30分</button>
                            <button type="button" class="btn btn-sm btn-outline-primary interval-btn" data-interval="1h">1時間</button>
                            <button type="button" class="btn btn-sm btn-outline-primary interval-btn" data-interval="4h">4時間</button>
                            <button type="button" class="btn btn-sm btn-outline-primary interval-btn" data-interval="1d">1日</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- チャートエラーメッセージ表示エリア -->
                    <div class="alert alert-danger d-none" id="chart-error-message" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span>チャートデータの取得に失敗しました。</span>
                    </div>
                    <div class="chart-container mb-4">
                        <div id="priceChart" style="width: 100%; height: 500px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- テクニカル指標チャートエリア -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> テクニカル指標</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div id="rsiChart" style="width: 100%; height: 250px; border: 1px solid #404040; border-radius: 5px;"></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div id="macdChart" style="width: 100%; height: 250px; border: 1px solid #404040; border-radius: 5px;"></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div id="volumeChart" style="width: 100%; height: 250px; border: 1px solid #404040; border-radius: 5px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- マニュアル取引エリア -->
    <div class="row mb-4">
        <!-- 価格チャート設定とマニュアル取引 -->
        <div class="col-md-7 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-wave-square me-2"></i> テクニカル指標</h5>
                    <div class="d-flex flex-wrap gap-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input indicator-checkbox" type="checkbox" id="rsi-check" value="rsi" checked>
                            <label class="form-check-label" for="rsi-check">RSI</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input indicator-checkbox" type="checkbox" id="macd-check" value="macd" checked>
                            <label class="form-check-label" for="macd-check">MACD</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input indicator-checkbox" type="checkbox" id="bollinger-check" value="bollinger" checked>
                            <label class="form-check-label" for="bollinger-check">ボリンジャーバンド</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input indicator-checkbox" type="checkbox" id="volume-check" value="volume" checked>
                            <label class="form-check-label" for="volume-check">出来高</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input indicator-checkbox" type="checkbox" id="sma-check" value="sma" checked>
                            <label class="form-check-label" for="sma-check">移動平均線</label>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- このセクションは不要になるため削除 -->
                </div>
            </div>
        </div>
        
        <!-- マニュアル取引 -->
        <div class="col-md-5 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-hand-point-right me-2"></i> マニュアル取引</h5>
                </div>
                <div class="card-body">
                    <form id="manual-trade-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="trading-pair" class="form-label">取引ペア</label>
                                <select class="form-select" id="trading-pair" name="symbol">
                                    <option value="BTC_JPY" {% if settings and settings.currency_pair == 'BTC_JPY' %}selected{% endif %}>BTC/JPY</option>
                                    <option value="ETH_JPY" {% if settings and settings.currency_pair == 'ETH_JPY' %}selected{% endif %}>ETH/JPY</option>
                                    <option value="LTC_JPY" {% if settings and settings.currency_pair == 'LTC_JPY' %}selected{% endif %}>LTC/JPY</option>
                                    <option value="XRP_JPY" {% if settings and settings.currency_pair == 'XRP_JPY' %}selected{% endif %}>XRP/JPY</option>
                                    <option value="DOGE_JPY" {% if settings and settings.currency_pair == 'DOGE_JPY' %}selected{% endif %}>DOGE/JPY</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="trade-amount" class="form-label">数量</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="trade-amount" name="amount" step="0.0001" min="0.0001" value="0.0001">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">プリセット</button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" data-amount="10" onclick="document.getElementById('trade-amount').value=10; return false;">10 (DOGE_JPY)</a></li>
                                        <li><a class="dropdown-item" href="#" data-amount="0.001" onclick="document.getElementById('trade-amount').value=0.001; return false;">0.001 (BTC_JPY)</a></li>
                                        <li><a class="dropdown-item" href="#" data-amount="0.01" onclick="document.getElementById('trade-amount').value=0.01; return false;">0.01 (ETH_JPY)</a></li>
                                        <li><a class="dropdown-item" href="#" data-amount="0.1" onclick="document.getElementById('trade-amount').value=0.1; return false;">0.1 (LTC_JPY)</a></li>
                                        <li><a class="dropdown-item" href="#" data-amount="0.5" onclick="document.getElementById('trade-amount').value=0.5; return false;">0.5 (XRP_JPY)</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-12 mt-3">
                                <div class="d-grid gap-2">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-success flex-grow-1 py-2" id="buy-btn">
                                            <i class="fas fa-arrow-up me-2"></i> 買い
                                        </button>
                                        <button type="button" class="btn btn-danger flex-grow-1 py-2" id="sell-btn">
                                            <i class="fas fa-arrow-down me-2"></i> 売り
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div id="trade-result" class="mt-3 d-none">
                        <!-- Trade result will be shown here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 最近の取引 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i> 最近の取引</h5>
                    <a href="{{ url_for('dashboard.trades') }}" class="btn btn-sm btn-outline-primary">すべて表示</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>日時</th>
                                    <th>ペア</th>
                                    <th>タイプ</th>
                                    <th>価格</th>
                                    <th>数量</th>
                                    <th>状態</th>
                                    <th>損益</th>
                                    <th>アクション</th>
                                </tr>
                            </thead>
                            <tbody id="recent-trades-tbody">
                                <tr>
                                    <td colspan="9" class="text-center">取引データがありません</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- トースト通知のコンテナ -->
    <div id="toast-container"></div>

    <!-- トレード確認モーダル -->
    <div class="modal fade" id="tradeConfirmModal" tabindex="-1" aria-labelledby="tradeConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tradeConfirmModalLabel">取引確認</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>
                        <span id="trade-type-text">買い</span>注文を
                        <span id="trade-amount-text">0.0001</span>
                        <span id="trade-symbol-text">XRP/JPY</span>で実行しますか？
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" id="confirm-trade-btn">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- トレードクローズ確認モーダル -->
    <div class="modal fade" id="closeTradeModal" tabindex="-1" aria-labelledby="closeTradeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="closeTradeModalLabel">トレードクローズの確認</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>このトレードをクローズしますか？この操作は元に戻せません。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-warning" id="confirm-close-btn">クローズ</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Google Charts ライブラリを使用 -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="{{ url_for('static', filename='js/dashboard_google.js') }}"></script>
{% endblock %}